; ═══════════════════════════════════════════════════════════════════
;  HXTP Embedded SDK v1.0 — PlatformIO Configuration
;
;  Environments:
;    esp32s3   — ESP32-S3-DevKitC-1 (Tier-1, primary target)
;    esp32     — ESP32-WROOM-32 (Tier-2, generic DevKit)
;    esp8266   — ESP8266 NodeMCU (Tier-3, constrained — BearSSL crypto)
;
;  Build:
;    pio run -e esp32s3
;    pio run -e esp32
;    pio run -e esp8266
;
;  Upload:
;    pio run -e esp32s3 -t upload
;
;  Monitor:
;    pio device monitor -b 115200
;
;  Copyright (c) 2026 Hestia Labs
;  SDK-License-Identifier: MIT
; ═══════════════════════════════════════════════════════════════════

[platformio]
default_envs = esp32s3
src_dir = src

; ── Shared settings ──────────────────────────────────────────────────

[env]
framework = arduino
monitor_speed = 115200
lib_deps =
    knolleary/PubSubClient@^2.8

build_flags =
    -std=gnu++17
    -fno-exceptions
    -fno-rtti
    -Os
    -flto
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -Wall
    -Wextra
    -Wno-unused-parameter
    ; ── Release hardening ──────────────────────────────────────
    -DCORE_DEBUG_LEVEL=0           ; suppress Arduino ESP32 debug logging
    -DCONFIG_ARDUHAL_LOG_COLORS=0  ; no ANSI color codes in log strings
    -DHXTP_RELEASE=1               ; SDK release mode marker

build_unflags =
    -std=gnu++11
    -std=gnu++14
    -fno-lto

; ── ESP32-S3 ─────────────────────────────────────────────────────────

[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
build_flags =
    ${env.build_flags}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; ── ESP32-WROOM ──────────────────────────────────────────────────────
;  Uses min_spiffs partition: 1.875 MB app (×2 OTA), 128 KB SPIFFS.
;  Default partition only gives 1.25 MB app — too tight at 77% flash.
;  min_spiffs preserves dual OTA while giving ~50% more app space.

[env:esp32]
platform = espressif32
board = esp32dev
board_build.mcu = esp32
board_build.f_cpu = 240000000L
board_build.partitions = min_spiffs.csv
build_flags =
    ${env.build_flags}

; ── ESP8266 ──────────────────────────────────────────────────────────
;  Tier-3 (Constrained). Uses BearSSL crypto adapter (no mbedTLS).
;  Auto-selects HXTP_CONSTRAINED profile via hxtp_config.h.
;  AES-256-GCM at-rest disabled by default; HMAC-SHA256 signing active.
;  BearSSL TLS: smaller fragment negotiation via setBufferSizes().

[env:esp8266]
platform = espressif8266@4.2.1
board = nodemcuv2
board_build.f_cpu = 160000000L
build_flags =
    -std=gnu++17
    -fno-exceptions
    -fno-rtti
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -Wall
    -Wextra
    -Wno-unused-parameter
    -DHXTP_RELEASE=1
    -DPIO_FRAMEWORK_ARDUINO_LWIP2_LOW_MEMORY
build_unflags =
    -std=gnu++11
    -std=gnu++14
