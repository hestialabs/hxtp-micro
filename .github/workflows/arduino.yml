# ═══════════════════════════════════════════════════════════════════
#  HXTP Embedded SDK — Arduino Library Release Pipeline
#
#  • Validates library compliance with arduino-lint on every push/PR
#  • On tag push (v*): extracts version from tag and creates GitHub Release
#  • Arduino Library Manager indexer picks up releases automatically (checks every hour)
#
#  Usage:
#    git tag v1.0.0
#    git push origin v1.0.0
#    → Triggers lint + creates GitHub Release → Arduino indexer picks it up
#
#  Prerequisites:
#    1. Register the library once by submitting a PR to
#       https://github.com/arduino/library-registry adding your
#       repo URL to repositories.txt
#    2. After that, every tagged release is auto-indexed
#
#  Copyright (c) 2026 Hestia Labs
# ═══════════════════════════════════════════════════════════════════

name: Arduino Library Release

on:
    push:
        tags: ["v*"]
    pull_request:
        branches: [main]
        paths:
            - "lib/HXTP/**"
            - ".github/workflows/arduino.yml"

jobs:
    # ── Lint: Arduino Library Specification compliance ────────────
    lint:
        name: Arduino Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Arduino Lint
              uses: arduino/arduino-lint-action@v2
              with:
                  path: lib/HXTP
                  library-manager: update
                  compliance: strict
                  project-type: library

    # ── Release: Tag + GitHub Release for Arduino indexer ─────────
    release:
        name: Release to Arduino Library Manager
        needs: lint
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Extract version from tag
              id: version
              run: |
                  TAG="${{ github.ref }}"
                  VERSION="${TAG#refs/tags/v}"
                  NAME=$(grep '^name=' lib/HXTP/library.properties | cut -d= -f2)
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
                  echo "name=$NAME" >> "$GITHUB_OUTPUT"
                  echo "Detected: $NAME v$VERSION from tag"

            - name: Create library archive
              run: |
                  cd lib/HXTP
                  zip -r ../../${{ steps.version.outputs.name }}-${{ steps.version.outputs.version }}.zip .
                  cd ../..
                  ls -lh ${{ steps.version.outputs.name }}-${{ steps.version.outputs.version }}.zip

            - name: Create GitHub Release (triggered by tag push)
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: "${{ steps.version.outputs.name }} ${{ steps.version.outputs.tag }}"
                  files: |
                      ${{ steps.version.outputs.name }}-${{ steps.version.outputs.version }}.zip
                  body: |
                      ## ${{ steps.version.outputs.name }} v${{ steps.version.outputs.version }}

                      Released for the [Arduino Library Manager](https://www.arduino.cc/reference/en/libraries/).

                      The Arduino Library Manager indexer checks for new releases every hour.
                      This version will be available for installation via **Sketch > Include Library > Manage Libraries...** shortly.

                      ### Install via Arduino CLI

                      ```bash
                      arduino-cli lib install "${{ steps.version.outputs.name }}"
                      ```

                      ### Install via PlatformIO

                      ```ini
                      lib_deps = ${{ steps.version.outputs.name }}
                      ```

                      ---
                      Commit: `${{ github.sha }}`
                  make_latest: true
